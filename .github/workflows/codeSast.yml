name: CodeQL SAST

on:
  push:
    branches: [ "main" ]

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build --if-present

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  notify:
    needs: analyze
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Send Discord notification
        run: |
          curl -H "Content-Type: application/json" \
          -d '{
                "embeds": [{
                  "title": "ðŸš¨ CodeQL SAST FAILED",
                  "color": 16711680,
                  "fields": [
                    {"name": "Repository", "value": "${{ github.repository }}", "inline": true},
                    {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                    {"name": "Commit", "value": "${{ github.sha }}", "inline": false},
                    {"name": "Actor", "value": "${{ github.actor }}", "inline": true},
                    {"name": "Workflow", "value": "CodeQL SAST", "inline": true}
                  ]
                }]
              }' \
          ${{ secrets.DISCORD_WEBHOOK_URL_CI }}
